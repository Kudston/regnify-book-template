name: Generate Client API Packages
on: 
  push:
    branches: [ develop, feature/auto-gen-client-packages ]

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
      - name: Setup
        run: sudo apt-get update && sudo apt-get install -y make && make create-network --ignore-errors

      # Had to do this to make the run-locally commands compatible (i.e docker-compose)
      - name: Installing docker-compose step - 1
        run: sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose;

      - name: Installing docker-compose step - 2
        run: sudo chmod +x /usr/local/bin/docker-compose;

      - name: Start REGNIFY API
        run: make run

      
      - name: Generate Client API - Typescript Axios
          #  You might need to specify the correct openapi.json url
        run: |
          mkdir /tmp/typescript-axios
          docker run --network=regnify-network --rm -v /tmp/typescript-axios:/local openapitools/openapi-generator-cli:v6.0.0  generate \
          -i http://regnify-api:8000/openapi.json \
          -g typescript-axios \
          -o /local/src

      - name: Debug folder
        run: ls /tmp/typescript-axios/src

      # PAT
      - name: Clone Repo into `/tmp/regnify-typescript.git`
        run: |
          cd /tmp
          git clone https://${{ secrets.PAT }}@github.com/codelorhd/regnify-api-ts-client.git
      
      - name: Update 
        run: cp -r /tmp/typescript-axios/src/* /tmp/regnify-typescript/

      - name: Debug folder
        run: ls /tmp/regnify-typescript/
    
      - name: setup git user
        run: git config --global user.email 'solesty7@gmail.com' && git config --global user.name 'Solomon ABOYEJI'

      - name: Update origin repo if changed (typescript-axios)
        run: |
          cd /tmp/regnify-typescript && git add .
          if [[ $(cd /tmp/regnify-typescript && git status --porcelain | wc -l) -gt 0 ]]
          then
          cd /tmp/regnify-typescript && git commit -m 'updated repo' && git push 
          else
          echo "not changed locally" 
          fi