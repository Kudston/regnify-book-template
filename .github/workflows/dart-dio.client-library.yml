name: Generate Dart DIO Client Library
# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Setup Server"]
    types:
      - completed

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
      - name: Generate Client API - Dart Dio
        run: |
          mkdir /tmp/dart-dio
          docker run --network=regnify-network --rm -v /tmp/dart-dio:/local openapitools/openapi-generator-cli generate -i http://regnify-api:8100/openapi.json -g dart-dio -o /local/src \
          -p pubAuthor="Solomon ABOYEJI" \
          -p pubAuthorEmail="talkto@regnify.com" \
          -p pubDescription="Auto-generated package for regnify platform" \
          -p pubHomepage="https://regnify.com" \
          -p pubLibrary="regnify.api" \
          -p pubName="regnify_core" \
          -p pubVersion="1.0.$GITHUB_RUN_NUMBER"

      - name: Debug folder
        run: ls /tmp/dart-dio/src

      # PAT
      - name: Clone Repo into `/tmp/regnify-dart-dio.git`
        run: |
          cd /tmp
          git clone https://${{ secrets.PAT }}@github.com/codelorhd/regnify-api-dart-dio-client.git
      
      - name: Update 
        run: cp -r /tmp/dart-dio/src/* /tmp/regnify-dart-dio/

      - name: Debug folder
        run: ls /tmp/regnify-dart-dio/
        

      - uses: subosito/flutter-action@v2
      - name: Running builder
        run: cd /tmp/regnify-dart-dio && flutter pub get && flutter pub run build_runner build --delete-conflicting-outputs && rm -r .dart_tool

      
      - name: Create .gitignore
        run: | 
          cd /tmp/regnify-dart-dio
          echo ".dart_tool" > .gitignore
          echo ".packages" >> .gitignore

      - name: setup git user
        run: git config --global user.email 'solesty7@gmail.com' && git config --global user.name 'Solomon ABOYEJI'

      - name: Update origin repo if changed (dart-dio-axios)
        run: |
          cd /tmp/regnify-dart-dio && git add .
          if [[ $(cd /tmp/regnify-dart-dio && git status --porcelain | wc -l) -gt 0 ]]
          then
          cd /tmp/regnify-dart-dio && git commit -m 'updated repo' && git push 
          else
          echo "not changed locally" 
          fi