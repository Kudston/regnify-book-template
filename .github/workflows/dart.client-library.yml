name: Generate Client API - Dart

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Setup Server"]
    types:
      - completed

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
      - name: Generate Client API - Dart
        run: |
          mkdir /tmp/dart
          docker run --network=regnify-network --rm -v /tmp/dart:/local openapitools/openapi-generator-cli generate -i http://regnify-api:8100/openapi.json -g dart -o /local/src \
          -p pubAuthor="Solomon ABOYEJI" \
          -p pubAuthorEmail="talkto@regnify.com" \
          -p pubDescription="Auto-generated package for regnify platform" \
          -p pubHomepage="https://regnify.com" \
          -p pubLibrary="regnify.api" \
          -p pubName="regnify_core" \
          -p pubVersion="1.0.$GITHUB_RUN_NUMBER"

      - name: Debug folder
        run: ls /tmp/dart/src

      # PAT
      - name: Clone Repo into `/tmp/regnify-dart.git`
        run: |
          cd /tmp
          git clone https://${{ secrets.PAT }}@github.com/codelorhd/regnify-api-dart-client.git
      
      - name: Update 
        run: cp -r /tmp/dart/src/* /tmp/regnify-dart/

      - name: Debug folder
        run: ls /tmp/regnify-dart/
    
      - name: setup git user
        run: git config --global user.email 'solesty7@gmail.com' && git config --global user.name 'Solomon ABOYEJI'

      - name: Update origin repo if changed (dart)
        run: |
          cd /tmp/regnify-dart && git add .
          if [[ $(cd /tmp/regnify-dart && git status --porcelain | wc -l) -gt 0 ]]
          then
          cd /tmp/regnify-dart && git commit -m 'updated repo' && git push 
          else
          echo "not changed locally" 
          fi